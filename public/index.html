<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IPSA Presidential Election</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
  </head>
  <body class="bg-gray-50 text-gray-900">
    <div class="max-w-3xl mx-auto p-4 sm:p-6">
      <header class="text-center mb-8">
        <h1 class="text-3xl font-bold">IPSA Presidential Election</h1>
        <p class="text-sm text-gray-500 mt-2">school vote app made by hisyam - 4ever - @2025</p>
      </header>

      <!-- Gate form -->
      <div id="gate" class="space-y-6">
        <div class="flex flex-col items-center">
          <div id="reader" class="w-64 h-64 border rounded-lg"></div>
          <p class="text-gray-500 text-sm mt-2">Scan your QR code</p>
        </div>
        <div class="flex items-center gap-4 justify-center">
          <div class="h-px flex-1 bg-gray-300"></div>
          <span class="text-sm text-gray-500">or</span>
          <div class="h-px flex-1 bg-gray-300"></div>
        </div>
        <div class="max-w-sm mx-auto">
          <label class="block mb-1 text-sm font-medium">Enter token manually</label>
          <input id="tokenInput" class="w-full rounded-md border-gray-300 p-2" placeholder="Enter your token" />
          <button id="continueBtn" class="mt-3 w-full py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Continue</button>
          <p id="gateError" class="mt-2 text-red-600 text-sm hidden"></p>
        </div>
      </div>

      <!-- Ballot -->
      <div id="ballot" class="hidden space-y-4">
        <h2 id="ballotTitle" class="text-xl font-semibold"></h2>
        <div id="maleSection" class="hidden">
          <p class="font-medium">Select one male candidate:</p>
          <div id="maleOptions" class="space-y-2 mt-2"></div>
        </div>
        <div id="femaleSection" class="hidden">
          <p class="font-medium">Select one female candidate:</p>
          <div id="femaleOptions" class="space-y-2 mt-2"></div>
        </div>
        <button id="voteBtn" class="py-2 px-4 rounded-md bg-green-600 text-white hover:bg-green-700">Cast Vote</button>
        <p id="voteError" class="text-red-600 text-sm hidden mt-2"></p>
      </div>

      <!-- Thank you -->
      <div id="thanks" class="hidden text-center space-y-3">
        <h2 class="text-xl font-semibold">Thank you for voting!</h2>
        <p>You will be redirected back to the start in <span id="countdown">5</span> seconds.</p>
        <button id="backBtn" class="py-2 px-4 rounded-md bg-green-600 text-white hover:bg-green-700">Back Now</button>
      </div>
    </div>

    <script>
      const tokenInput = document.getElementById('tokenInput');
      const gate = document.getElementById('gate');
      const ballot = document.getElementById('ballot');
      const thanks = document.getElementById('thanks');
      const gateError = document.getElementById('gateError');
      const voteError = document.getElementById('voteError');
      const maleSection = document.getElementById('maleSection');
      const femaleSection = document.getElementById('femaleSection');
      const maleOptions = document.getElementById('maleOptions');
      const femaleOptions = document.getElementById('femaleOptions');
      const ballotTitle = document.getElementById('ballotTitle');
      let current = { token: '', role: '', candidates: {} };

      // Fetch token info
      async function openToken(token) {
        gateError.classList.add('hidden');
        voteError.classList.add('hidden');
        const res = await fetch('/api/open', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) {
          gateError.textContent = data.error || 'Invalid token';
          gateError.classList.remove('hidden');
          return;
        }
        if (data.used) {
          gateError.textContent = 'This token has already been used';
          gateError.classList.remove('hidden');
          return;
        }
        current = data;
        // build ballot
        ballotTitle.textContent =
          current.role === 'male'
            ? 'Male Student Ballot'
            : current.role === 'female'
            ? 'Female Student Ballot'
            : 'Teacher Ballot';
        maleOptions.innerHTML = '';
        femaleOptions.innerHTML = '';
        if (current.role === 'male' || current.role === 'teacher') {
          current.candidates.male.forEach((name) => {
            const id = `m_${name.replace(/\s+/g, '')}`;
            maleOptions.insertAdjacentHTML(
              'beforeend',
              `<label class="flex items-center gap-2"><input type="radio" name="malePick" value="${name}" class="h-4 w-4"><span>${name}</span></label>`
            );
          });
          maleSection.classList.remove('hidden');
        } else {
          maleSection.classList.add('hidden');
        }
        if (current.role === 'female' || current.role === 'teacher') {
          current.candidates.female.forEach((name) => {
            const id = `f_${name.replace(/\s+/g, '')}`;
            femaleOptions.insertAdjacentHTML(
              'beforeend',
              `<label class="flex items-center gap-2"><input type="radio" name="femalePick" value="${name}" class="h-4 w-4"><span>${name}</span></label>`
            );
          });
          femaleSection.classList.remove('hidden');
        } else {
          femaleSection.classList.add('hidden');
        }
        // show ballot
        gate.classList.add('hidden');
        ballot.classList.remove('hidden');
      }

      // Cast vote
      document.getElementById('voteBtn').addEventListener('click', async () => {
        voteError.classList.add('hidden');
        const malePick = document.querySelector('input[name="malePick"]:checked')?.value || '';
        const femalePick = document.querySelector('input[name="femalePick"]:checked')?.value || '';
        const payload = {
          token: current.token,
          pick_male: malePick,
          pick_female: femalePick
        };
        const res = await fetch('/api/vote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) {
          voteError.textContent = data.error || 'Error submitting vote';
          voteError.classList.remove('hidden');
          return;
        }
        ballot.classList.add('hidden');
        thanks.classList.remove('hidden');
        let seconds = 5;
        const countdownSpan = document.getElementById('countdown');
        countdownSpan.textContent = seconds;
        const interval = setInterval(() => {
          seconds--;
          countdownSpan.textContent = seconds;
          if (seconds <= 0) {
            clearInterval(interval);
            window.location.href = '/';
          }
        }, 1000);
      });

      document.getElementById('backBtn').addEventListener('click', () => {
        window.location.href = '/';
      });

      document.getElementById('continueBtn').addEventListener('click', () => {
        const t = tokenInput.value.trim();
        if (t) openToken(t);
      });

      // handle query param ?t=TOKEN
      const urlParams = new URLSearchParams(window.location.search);
      const tParam = urlParams.get('t');
      if (tParam) {
        tokenInput.value = tParam;
        openToken(tParam);
      }

      // Initialize QR scanner
      function initScanner() {
        if (typeof Html5Qrcode === 'undefined') return;
        const html5QrCode = new Html5Qrcode('reader');
        Html5Qrcode.getCameras()
          .then((devices) => {
            if (!devices || devices.length === 0) return;
            const cameraId = devices[0].id;
            html5QrCode.start(
              cameraId,
              { fps: 10, qrbox: 200 },
              (decodedText) => {
                html5QrCode.stop();
                try {
                  const u = new URL(decodedText);
                  const param = u.searchParams.get('t');
                  if (param) {
                    tokenInput.value = param;
                    openToken(param);
                    return;
                  }
                } catch (err) {}
                // fallback treat code as token
                tokenInput.value = decodedText;
                openToken(decodedText);
              }
            );
          })
          .catch(() => {});
      }
      window.addEventListener('load', initScanner);
    </script>
  </body>
</html>